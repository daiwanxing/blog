import{_ as p,o as t,c as e,b as n,a as s,e as c}from"./app.eafee0db.js";const o={},l=s(`<div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">effect</span> <span class="token punctuation">(</span><span class="token parameter">eff</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    activeEffect <span class="token operator">=</span> eff<span class="token punctuation">;</span>
    <span class="token function">activeEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> targetDepMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u5B58\u50A8\u4E86\u6BCF\u4E2A\u54CD\u5E94\u5F0F\u5BF9\u8C61\u7684\u4F9D\u8D56</span>

<span class="token comment">// track\u8D1F\u8D23\u5C06effect\u6DFB\u52A0\u4F9D\u8D56\u5230dep\uFF0C\u6BCF\u4E00\u4E2A\u5C5E\u6027\u90FD\u6709\u4E00\u4E2A\u81EA\u5DF1\u7684dep,\u5F53\u5BF9\u67D0\u4E2A\u5C5E\u6027\u5462\u884Cset\u64CD\u4F5C\u65F6\uFF0C\u89E6\u53D1\u8BE5\u5C5E\u6027\u5BF9\u5E94\u7684effect</span>
<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetDepMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u53D6\u51FAtargetDepMap\u4E2D\u7684depsMap</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u4E0D\u5B58\u5728depsMap    </span>
            depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            targetDepMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> depsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u6BCF\u4E00\u4E2A\u5C5E\u6027\u90FD\u5E94\u8BE5\u62E5\u6709\u4E00\u4E2A\u81EA\u5DF1\u7684dep\uFF0Cdep\u7684\u952E\u540D\u4E3A\u5C5E\u6027\u540D\uFF0C\u4E00\u4E2A\u5C5E\u6027\u53EF\u4EE5\u6709\u591A\u4E2Adep</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u6784\u5EFA\u4E00\u4E2A\u76EE\u6807\u4F9D\u8D56\u56FE\uFF0C\u5982\u679C\u4E0D\u5B58\u5728dep\uFF0C\u65B0\u5EFA\u4E00\u4E2Aset\uFF0C\u5B58\u653E\u7684\u662F\u5404\u4E2Aeffect</span>
            dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// trigget \u89E6\u53D1\u4F9D\u8D56\uFF0C \u9996\u5148\u68C0\u67E5\u5BF9\u8C61 \u201D\u62E5\u6709dep \u201D</span>
<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetDepMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u503C\u662F\u4E00\u4E2Amap</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  \u5F97\u5230\u4E00\u4E2Aset</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">// track \u8D1F\u8D23\u6536\u96C6dep</span>
        <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// trigger</span>
        <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u6211\u4EEC\u90FD\u77E5\u9053set\u89E6\u53D1dep\uFF0C \u5982\u679ColaVal\u548CnewVal\u4E00\u81F4\uFF0C\u5C31\u65E0\u9700\u89E6\u53D1</span>
            <span class="token keyword">let</span> oldVal <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!==</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">let</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> salePrice <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> product <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">price</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token literal-property property">quantity</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>product<span class="token punctuation">.</span>price<span class="token punctuation">,</span> product<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    total <span class="token operator">=</span> product<span class="token punctuation">.</span>price <span class="token operator">*</span> product<span class="token punctuation">.</span>quantity
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    salePrice <span class="token operator">=</span> product<span class="token punctuation">.</span>price <span class="token operator">*</span> <span class="token number">0.9</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Vue3 \u54CD\u5E94\u5F0F\u7CFB\u7EDF\u6570\u636E\u7ED3\u6784</p><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code>WeakMap -&gt; Map -&gt; Set
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,3),i=c("\u5176\u6570\u636E\u7ED3\u6784\u5982\u4E0B\u56FE\u6240\u793A\uFF1A "),u=["src"],k=s(`<div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> normalData <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;lucy&quot;</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token number">21</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> reactiveData <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>normalData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> depMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reactiveData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    depMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> effect<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// WeakMap\u7684key\u662F\u672A\u88AB\u52AB\u6301\u7684\u5BF9\u8C61\u672C\u8EAB\uFF0CValue\u5219\u662F\u54CD\u5E94\u5F0FMap, \u5F53\u5BF9\u8C61\u9500\u6BC1\u65F6\u5BF9\u5E94\u7684Map\u4E5F\u4F1A\u9500\u6BC1\u3002</span>

<span class="token comment">// \u800CMap\u7684key\u5219\u662F\u54CD\u5E94\u5F0F\u5BF9\u8C61\u7684\u6BCF\u4E2AProperty\uFF0C value\u662F\u4F9D\u8D56\u8FD9\u4E2A\u5BF9\u8C61\u5C5E\u6027\u7684effect\u51FD\u6570\u96C6\u5408</span>

<span class="token keyword">const</span> reactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span>normalData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u901A\u5E38\u6240\u8BF4\u7684\u4F9D\u8D56\u6536\u96C6\uFF0C\u5373\u6536\u96C6\u54CD\u5E94\u5F0F\u5BF9\u8C61\u5C5E\u6027\u7684effect\u5C06\u5176\u5B58\u5165\u5230dep-set\u4E2D\u3002</p><p>\u6211\u4EEC\u901A\u5E38\u6240\u8BF4\u7684\u6D3E\u53D1\u66F4\u65B0\uFF0C\u4E5F\u79F0\u4E4B\u4E3A\u89E6\u53D1\u4F9D\u8D56\uFF0C\u5373\u4FEE\u6539\u5BF9\u8C61\u5C5E\u6027\u7684\u65F6\u5019\u4ECEdep-set\u4E2D\u4EE5\u6B64\u6267\u884C\u6240\u6709\u7684effect\u3002</p>`,3);function r(a,d){return t(),e("div",null,[l,n("p",null,[i,n("img",{src:a.$withBase("/rn.png"),alt:"\u54CD\u5E94\u5F0F\u6570\u636E\u7ED3\u6784\u56FE"},null,8,u)]),k])}var m=p(o,[["render",r],["__file","reactive.html.vue"]]);export{m as default};
